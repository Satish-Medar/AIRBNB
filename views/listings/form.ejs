<% layout("/layouts/boilerplate") %>

<body class="bg-light">
  <div class="container py-5">
    <div class="row justify-content-center">
      <div class="col-lg-8 col-md-10">
        <!-- Heading -->
        <div class="text-center mb-4">
          <h2 class="fw-bold">Create a New Listing</h2>
          <p class="text-muted">Add details for your property</p>
        </div>

        <!-- Form Card -->
        <div class="card shadow-sm border-0 rounded-4 p-4">
          <form
            action="/listings"
            method="post"
            enctype="multipart/form-data"
            class="needs-validation"
            novalidate
          >
            <!-- Title -->
            <div class="mb-4">
              <label class="form-label fw-semibold">Listing Title</label>
              <input
                type="text"
                class="form-control rounded-3"
                name="listing[title]"
                placeholder="Enter a catchy title"
                value="<%= typeof formData !== 'undefined' && formData ? (formData.title || '') : '' %>"
                required
              />
              <div class="invalid-feedback">Please enter a valid title.</div>
            </div>

            <!-- Description -->
            <div class="mb-4">
              <label class="form-label fw-semibold">Description</label>
              <textarea
                class="form-control rounded-3"
                name="listing[desc]"
                placeholder="Describe your place"
                style="height: 120px"
                maxlength="5000"
                required
              ></textarea>
              <script>
                // Inline replacement for textarea value since value attribute doesn't work for textarea in EJS neatly
              </script>
              <%= typeof formData !== 'undefined' && formData && formData.desc ? '<script>document.addEventListener("DOMContentLoaded",()=>{const ta=document.querySelector("textarea[name=\"listing[desc]\"]"); if(ta) ta.value = ' + JSON.stringify(formData.desc) + ';})</script>' : '' %>
              <div class="form-text text-muted">
                <span id="descCount">0</span>/5000 characters
                <span id="descWarn" class="ms-2 text-warning visually-hidden" aria-live="polite"></span>
              </div>
              <script>
                document.addEventListener('DOMContentLoaded', function(){
                  const ta = document.querySelector('textarea[name="listing[desc]"]');
                  const counter = document.getElementById('descCount');
                  const warn = document.getElementById('descWarn');
                  const LIMIT = 5000, WARN_THRESHOLD = 200;
                  if(!ta || !counter || !warn) return;
                  function update(){
                    const len = ta.value.length;
                    counter.textContent = len;
                    const remaining = LIMIT - len;
                    if(len > LIMIT) {
                      ta.classList.add('is-invalid');
                    } else {
                      ta.classList.remove('is-invalid');
                    }
                    if(remaining <= WARN_THRESHOLD && remaining >= 0){
                      warn.classList.remove('visually-hidden');
                      warn.textContent = remaining === 0 ? 'You have reached the 5000 character limit.' : `${remaining} characters remaining`;
                    } else {
                      warn.classList.add('visually-hidden');
                      warn.textContent = '';
                    }
                  }
                  // initialize
                  update();
                  ta.addEventListener('input', update);
                });
              </script>
              <div class="invalid-feedback">Please enter a description (10-5000 characters).</div>
            </div>

            <!-- Image -->
            <div class="mb-4">
              <label class="form-label fw-semibold">Upload Image</label>
              <input
                type="file"
                class="form-control rounded-3"
                name="listing[image]"
                accept="image/*"
                required
              />
              <div class="invalid-feedback">Please upload an image.</div>
            </div>

            <!-- Price -->
            <div class="mb-4">
              <label class="form-label fw-semibold">Price (per night)</label>
              <input
                type="number"
                class="form-control rounded-3"
                name="listing[price]"
                placeholder="Enter price"
                value="<%= typeof formData !== 'undefined' && formData ? (formData.price || '') : '' %>"
                required
              />
              <div class="invalid-feedback">Please enter a valid price.</div>
            </div>

            <!-- Location + Country -->
            <div class="row">
              <div class="col-md-6 mb-4">
                <label class="form-label fw-semibold">Location</label>
                <input
                  type="text"
                  class="form-control rounded-3"
                  name="listing[location]"
                  placeholder="City / Area"
                  value="<%= typeof formData !== 'undefined' && formData ? (formData.location || '') : '' %>"
                  required
                />
                <div class="invalid-feedback">Please enter location.</div>
              </div>

              <div class="col-md-6 mb-4">
                <label class="form-label fw-semibold">Country</label>
                <input
                  type="text"
                  class="form-control rounded-3"
                  name="listing[country]"
                  placeholder="Country"
                  value="<%= typeof formData !== 'undefined' && formData ? (formData.country || '') : '' %>"
                  required
                />
                <div class="invalid-feedback">Please enter country.</div>
              </div>
            </div>

            <!-- Category -->
            <div class="mb-4">
              <label class="form-label fw-semibold">Category</label>
              <select
                class="form-select rounded-3"
                name="listing[category]"
                required
              >
                <option value="Rooms" <%= typeof formData !== 'undefined' && formData && formData.category === 'Rooms' ? 'selected' : '' %>>Rooms</option>
                <option value="Iconic Cities" <%= typeof formData !== 'undefined' && formData && formData.category === 'Iconic Cities' ? 'selected' : '' %>>Iconic Cities</option>
                <option value="Mountains" <%= typeof formData !== 'undefined' && formData && formData.category === 'Mountains' ? 'selected' : '' %>>Mountains</option>
                <option value="Castles" <%= typeof formData !== 'undefined' && formData && formData.category === 'Castles' ? 'selected' : '' %>>Castles</option>
                <option value="Arctic" <%= typeof formData !== 'undefined' && formData && formData.category === 'Arctic' ? 'selected' : '' %>>Arctic</option>
                <option value="Camping" <%= typeof formData !== 'undefined' && formData && formData.category === 'Camping' ? 'selected' : '' %>>Camping</option>
                <option value="Farms" <%= typeof formData !== 'undefined' && formData && formData.category === 'Farms' ? 'selected' : '' %>>Farms</option>
                <option value="Pools" <%= typeof formData !== 'undefined' && formData && formData.category === 'Pools' ? 'selected' : '' %>>Pools</option>
                <option value="Domes" <%= typeof formData !== 'undefined' && formData && formData.category === 'Domes' ? 'selected' : '' %>>Domes</option>
                <option value="Boats" <%= typeof formData !== 'undefined' && formData && formData.category === 'Boats' ? 'selected' : '' %>>Boats</option>
                <option value="Trending" <%= typeof formData !== 'undefined' && formData && formData.category === 'Trending' ? 'selected' : '' %>>Trending</option>
              </select>
            </div>

            <!-- Buttons -->
            <div class="d-flex gap-3 mt-4">
              <button
                type="button"
                class="btn btn-outline-secondary w-50 rounded-3"
                onclick="window.location='/listings'"
              >
                Cancel
              </button>

              <button type="submit" class="btn btn-success w-50 rounded-3">
                Create Listing
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</body>
