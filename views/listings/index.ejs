<% layout("/layouts/boilerplate") %>
<style>
  .filter i {
    font-size: 1.5rem;
  }
  .filters {
    align-items: center;
  }
  .filter {
    opacity: 0.7;
  }
  .filter:hover {
    opacity: 1;
    cursor: pointer;
  }
  .filter p {
    font-size: 0.8rem;
  }
  .tax-toggle {
    border: 1px solid black;
    border-radius: 1rem;
    height: 3.2rem;
    padding: 1rem;
    margin-left: 1rem;
    display: flex;
    align-items: center;
    margin-top: 1.8rem;
  }

  /* === FIX FOR UNEVEN LISTING CARDS LAYOUT === */

  
  /* Responsive Breakpoints */
  @media (max-width: 1200px) {
      #cards-container {
          grid-template-columns: repeat(3, 1fr); 
      }
  }
  @media (max-width: 768px) {
      #cards-container {
          grid-template-columns: repeat(2, 1fr); 
      }
  }
  @media (max-width: 576px) {
      #cards-container {
          grid-template-columns: 1fr; 
      }
  }
  #cards-container {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 1.5rem;

    /* KEY FIX */
    grid-auto-rows: 1fr;
}
</style>

<div class="filters d-flex flex-wrap">
  <% if (Array.isArray(categories)) { %> <% categories.forEach(function(cat) {
  %>
  <a
    href="/listings/filter/<%= encodeURIComponent(cat.name) %>"
    data-cat="<%= cat.name %>"
    onclick="event.preventDefault(); document.getElementById('categoryInput').value='<%= cat.name %>'; document.getElementById('listFilters').submit();"
    role="button"
    tabindex="0"
    aria-pressed="<%= (typeof selectedCategory !== 'undefined' && selectedCategory === cat.name) ? 'true' : 'false' %>"
    class="filter text-center me-4 mt-4 text-decoration-none <%= (typeof selectedCategory !== 'undefined' && selectedCategory === cat.name) ? 'active-filter' : '' %>"
  >
    <div><i class="<%= cat.iconClass %>" aria-hidden="true"></i></div>
    <p class="mb-0 mt-1" style="font-size: 0.85rem"><%= cat.name %></p>
  </a>
  <% }) %> <% } %>

  <div class="tax-toggle">
    <div class="form-check form-switch form-check-reverse">
      <input
        class="form-check-input"
        type="checkbox"
        role="switch"
        id="switchCheckDefault"
      />
      <label class="form-check-label" for="switchCheckDefault"
        >Display total after taxes</label
      >
    </div>
  </div>
</div>
<div class="mt-3 mb-3">
  <form id="listFilters" method="GET" action="/listings" class="row g-2 align-items-center">
    <div class="col-auto">
      <label class="form-label visually-hidden" for="sortSelect">Sort</label>
      <select id="sortSelect" name="sort" class="form-select">
        <option value="new" <%= sort === 'new' ? 'selected' : '' %>>Newest</option>
        <option value="price_asc" <%= sort === 'price_asc' ? 'selected' : '' %>>Price: Low to High</option>
        <option value="price_desc" <%= sort === 'price_desc' ? 'selected' : '' %>>Price: High to Low</option>
        <option value="rating_desc" <%= sort === 'rating_desc' ? 'selected' : '' %>>Top Rated</option>
      </select>
    </div>

    <div class="col-auto d-flex">
      <input type="number" name="minPrice" class="form-control" placeholder="Min price" value="<%= minPrice %>" />
      <input type="number" name="maxPrice" class="form-control ms-2" placeholder="Max price" value="<%= maxPrice %>" />
    </div>

    <div class="col-auto">
      <input type="hidden" name="category" value="<%= selectedCategory || '' %>" id="categoryInput" />
      <button type="submit" class="btn btn-accent">Apply</button>
    </div>
  </form>
</div>

<div id="cards-container" class="mt-3">
  <%- include('./_cards.ejs', { listings: (typeof listings !== 'undefined' ? listings : (allListings || [])) }) %>
</div>

<div class="d-flex justify-content-center mt-4">
  <% const moreAvailable = (total > (page * limit)); %> <% if (moreAvailable) {
  %>
  <button
    id="loadMoreBtn"
    class="btn btn-outline-primary"
    data-page="<%= page+1 %>"
  >
    Load more
  </button>
  <% } else { %>
  <div class="text-muted">No more results</div>
  <% } %>
</div>

<script>
  (function () {
    const loadMoreBtn = document.getElementById("loadMoreBtn");
    if (!loadMoreBtn) return;
    loadMoreBtn.addEventListener("click", async function () {
      const nextPage = this.getAttribute("data-page");
      this.disabled = true;
      this.innerText = "Loading...";
      // build current query params + ajax=1
      const params = new URLSearchParams(window.location.search);
      params.set("ajax", "1");
      params.set("page", nextPage);
      try {
        const res = await fetch(
          window.location.pathname + "?" + params.toString()
        );
        if (!res.ok) throw new Error("Network");
        const html = await res.text();
        const container = document.getElementById("cards-container");
        // insert returned cards HTML
        const temp = document.createElement("div");
        temp.innerHTML = html;
        // append only element children from temp to avoid stray text nodes
        Array.from(temp.children).forEach((child) => container.appendChild(child));
        // update button page and state
        const newPage = parseInt(nextPage) + 1;
        this.setAttribute("data-page", newPage);
        // check if more exists by comparing rendered count
        // Simple approach: if returned less than limit, hide
        if (html.trim().length === 0) {
          this.style.display = "none";
        } else {
          this.disabled = false;
          this.innerText = "Load more";
        }
      } catch (e) {
        console.error(e);
        this.disabled = false;
        this.innerText = "Load more";
      }
    });
  })();
</script>

<script>
  let taxswitch = document.getElementById("switchCheckDefault");
  taxswitch.addEventListener("click", () => {
    let taxInfo = document.getElementsByClassName("tax-info");
    for (info of taxInfo) {
      if (info.style.display != "inline") {
        info.style.display = "inline";
      } else {
        info.style.display = "none";
      }
    }
  });
</script>

<script>
  (function () {
    try {
      const params = new URLSearchParams(window.location.search);
      if (!params.has('gridDebug')) return;
      const container = document.getElementById('cards-container');
      if (!container) return;
      const rows = [];
      const report = [];
      Array.from(container.children).forEach((child, idx) => {
        // visual badge
        child.style.outline = '2px dashed rgba(255,56,92,0.6)';
        child.style.position = child.style.position || 'relative';
        const badge = document.createElement('div');
        badge.textContent = idx + 1;
        badge.style.position = 'absolute';
        badge.style.top = '6px';
        badge.style.left = '6px';
        badge.style.background = 'rgba(0,0,0,0.6)';
        badge.style.color = '#fff';
        badge.style.padding = '2px 6px';
        badge.style.borderRadius = '4px';
        badge.style.fontSize = '12px';
        badge.style.zIndex = 9999;
        child.appendChild(badge);

        // diagnostics info
        const rect = child.getBoundingClientRect();
        report.push({ index: idx + 1, tag: child.tagName.toLowerCase(), classes: child.className, top: Math.round(rect.top), height: Math.round(rect.height) });
        rows.push(Math.round(rect.top));
      });
      console.table(report);
      // group by top coordinate to show rows
      const grouped = {};
      report.forEach(r => { grouped[r.top] = grouped[r.top] || []; grouped[r.top].push(r.index); });
      console.info('Grid rows (by top offset):', grouped);
    } catch (e) {
    // ignore
    }
  })();
</script>