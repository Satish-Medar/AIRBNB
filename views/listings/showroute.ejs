<% layout("/layouts/boilerplate") %>
<script>
  const mapToken = "<%= process.env.MAPTILER_API_KEY %>";
  // Render the `listing` object as JSON for the client script.
  const listing = <%- JSON.stringify(listing) %>;
</script>

<div class="mt-4 mb-4">
  <div class="d-flex align-items-center mb-2">
    <a
      href="/listings"
      onclick="event.preventDefault(); window.history.back();"
      class="btn btn-sm btn-outline-secondary me-3"
      aria-label="Go back to listings"
      >← Back</a
    >
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb bg-transparent p-0 mb-2">
        <li class="breadcrumb-item"><a href="/listings">All Listings</a></li>
        <li class="breadcrumb-item active" aria-current="page">
          <%= listing.title %>
        </li>
      </ol>
    </nav>
  </div>

  <div class="row align-items-center">
    <div class="col-12 col-md-8">
      <h2 class="listing-title mb-0"><%= listing.title %></h2>
      <p class="text-muted owner-info small mt-1">
        Owned by: <%= listing.owner?.username || 'Unknown' %>
      </p>
    </div>
    <div class="col-12 col-md-4 text-md-end mt-3 mt-md-0">
      <span class="price-badge"
        >₹<%= listing.price ? Number(listing.price).toLocaleString('en-IN') :
        'N/A' %></span
      >
    </div>
  </div>
</div>

<!-- MAIN CARD -->
<div class="card showcard w-100 mb-4 shadow-sm">
  <div class="row g-3 p-3 align-items-start">
    <!-- LEFT: Gallery -->
    <div class="col-12 col-lg-7">
      <div class="mb-3 main-image-wrapper rounded overflow-hidden">
        <img
          src="<%= listing.image?.url %>"
          class="img-fluid main-image"
          loading="lazy"
          alt="<%= listing.title %>"
        />
      </div>

      <div class="row gx-2">
        <div class="col-3">
          <img
            src="<%= listing.image?.url %>"
            class="img-thumbnail thumb-img"
            alt="thumb"
          />
        </div>
        <div class="col-3">
          <img
            src="<%= listing.image?.url %>"
            class="img-thumbnail thumb-img"
            alt="thumb"
          />
        </div>
        <div class="col-3">
          <img
            src="<%= listing.image?.url %>"
            class="img-thumbnail thumb-img"
            alt="thumb"
          />
        </div>
        <div class="col-3">
          <img
            src="<%= listing.image?.url %>"
            class="img-thumbnail thumb-img"
            alt="thumb"
          />
        </div>
      </div>
    </div>

    <!-- RIGHT: Details + Map -->
    <div class="col-12 col-lg-5">
      <div class="card-body">
        <h4 class="mb-2">About this place</h4>
        <p class="text-muted">
          <%= listing.desc || 'No description provided yet.' %>
        </p>

        <ul class="list-group list-group-flush mb-3">
          <li class="list-group-item">
            <strong>Location:</strong> <%= listing.location || 'N/A' %>
          </li>
          <li class="list-group-item">
            <strong>Country:</strong> <%= listing.country || 'N/A' %>
          </li>
          <li class="list-group-item">
            <strong>Owner:</strong> <%= listing.owner?.username || 'Unknown' %>
          </li>
        </ul>

        <div class="mb-3">
          <h6 class="mb-1">Where you'll be</h6>
          <div id="map" class="rounded"></div>
        </div>

        <div class="d-flex gap-2">
          <a
            href="/listings/<%= listing._id %>/edit"
            class="btn btn-sm btn-outline-primary"
            >Edit</a
          >
          <form
            action="/listings/<%= listing._id %>"
            method="POST"
            class="d-inline"
            onsubmit="return confirm('Are you sure you want to delete this listing?');"
          >
            <input type="hidden" name="_method" value="DELETE" />
            <button type="submit" class="btn btn-sm btn-danger">Delete</button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- Removed duplicate details and legacy full-width buttons; review form moved below reviews. -->

<div class="text-success">
  <hr class="mt-5" />
</div>

<!-- REVIEW BOXES -->
<h4 class="mt-5 d-flex align-items-center">
  All Reviews
  <span class="badge bg-primary ms-2"
    ><%= listing.reviews ? listing.reviews.length : 0 %></span
  >
</h4>

<div class="row gy-4 mt-3">
  <% if (listing.reviews && listing.reviews.length) { %> <%
  listing.reviews.forEach(function (review) { %>
  <div class="col-12 col-md-6 col-lg-4">
    <div class="card h-100 shadow-sm rounded-3">
      <div class="card-body d-flex flex-column p-3 p-md-4">
        <div class="d-flex align-items-start mb-2">
          <div
            class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center me-3"
            style="width: 48px; height: 48px; font-weight: 600"
          >
            <%= review.author?.username ?
            review.author.username.charAt(0).toUpperCase() : 'U' %>
          </div>

          <div>
            <h6 class="mb-0"><%= review.author?.username || 'Unknown' %></h6>
            <% if (review.createdAt) { %>
            <small class="text-muted"
              ><%= new Date(review.createdAt).toLocaleDateString('en-IN', {
              year: 'numeric', month: 'short', day: 'numeric' }) %></small
            >
            <% } %>
          </div>
        </div>

        <h5 class="text-muted flex-grow-1 mb-3"><%= review.comment %></h5>

        <div class="d-flex justify-content-between align-items-center">
          <div>
            <p class="starability-result" data-rating="<%= review.rating %>">
              Rated: <%= review.rating %> stars
            </p>
          </div>

          <form
            action="/listings/<%= listing._id %>/reviews/<%= review._id %>"
            method="POST"
            onsubmit="return confirm('Are you sure you want to delete this review?');"
          >
            <input type="hidden" name="_method" value="DELETE" />
            <button type="submit" class="btn btn-sm btn-outline-danger">
              Delete
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>
  <% }) %> <% } else { %>
  <div class="col-12">
    <div class="alert alert-secondary mb-0 p-3">
      No reviews yet — be the first to leave one!
    </div>
  </div>
  <% } %>
</div>

<% if (currentUser) { %>
<div class="row mt-4">
  <div class="col-12 col-lg-8">
    <div class="review-card">
      <h4 class="mb-3">Leave a Review</h4>
      <form
        action="/listings/<%= listing._id %>/reviews"
        method="POST"
        novalidate
        class="needs-validation"
      >
        <div class="mb-3">
          <label class="form-label">Write Comment</label>
          <div class="form-floating">
            <textarea
              class="form-control"
              placeholder="Leave a comment"
              id="floatingTextarea2"
              name="review[comment]"
              required
            ></textarea>
            <label for="floatingTextarea2">Comment</label>
            <div class="invalid-feedback">Please enter a comment.</div>
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label">Rate out of 5</label>
          <fieldset class="starability-slot">
            <legend class="visually-hidden">Rate this listing</legend>
            <input
              type="radio"
              id="rate1"
              name="review[rating]"
              value="1"
              required
            />
            <label for="rate1">1 star</label>
            <input type="radio" id="rate2" name="review[rating]" value="2" />
            <label for="rate2">2 stars</label>
            <input type="radio" id="rate3" name="review[rating]" value="3" />
            <label for="rate3">3 stars</label>
            <input type="radio" id="rate4" name="review[rating]" value="4" />
            <label for="rate4">4 stars</label>
            <input type="radio" id="rate5" name="review[rating]" value="5" />
            <label for="rate5">5 stars</label>
          </fieldset>
        </div>

        <div class="review-actions">
          <button type="submit" class="btn btn-success">Submit</button>
          <small class="text-muted ms-2"
            >Your review will appear after approval.</small
          >
        </div>
      </form>
    </div>
  </div>
</div>
<% } %>
