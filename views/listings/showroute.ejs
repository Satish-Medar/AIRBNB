<% layout("/layouts/boilerplate") %>
  <script>
    const mapToken = "<%= process.env.MAPTILER_API_KEY%>";
    const listing = <%- JSON.stringify(listing) %>;
  </script>

  <div class="container">
    <div class="mt-4 mb-4">
      <h3>
        <%= listing.title %>
      </h3>
    </div>

    <!-- MAIN CARD -->
    <div class="card showcard w-100 mb-4">
      <div class="row g-2">
        <!-- LEFT MAIN IMAGE -->
        <div class="col-12 col-md-6">
          <img src="<%= listing.image.url %>" class="img-fluid w-100 rounded-top-start-5"
            style="max-height: 400px; object-fit: cover" alt="" />
        </div>

        <!-- RIGHT IMAGE GRID -->
        <div class="col-12 col-md-6">
          <div class="row gx-2 gy-0">
            <div class="col-6">
              <img src="<%= listing.image.url %>" class="img-fluid w-100 rounded-bottom-start-5"
                style="max-height: 200px; object-fit: cover" alt="" />
            </div>

            <div class="col-6">
              <img src="<%= listing.image.url %>" class="img-fluid w-100 rounded-bottom-end-5"
                style="max-height: 200px; object-fit: cover" alt="" />
            </div>
          </div>

          <div class="row gx-2 gy-0 mt-2">
            <div class="col-6">
              <img src="<%= listing.image.url %>" class="img-fluid w-100 rounded-top-start-5"
                style="max-height: 193px; object-fit: cover" alt="" />
            </div>

            <div class="col-6">
              <img src="<%= listing.image.url %>" class="img-fluid w-100 rounded-top-end-5"
                style="max-height: 193px; object-fit: cover" alt="" />
            </div>
          </div>
        </div>
      </div>

      <!-- TEXT -->
      <div class="card-body">
        <h3 class="card-title mt-3">
          <%= listing.title %>
        </h3>
        <p class="card-text">
          <%= listing.desc %>
        </p>
      </div>

      <i>Owned by: <%= listing.owner.username %></i>

      <ul class="list-group list-group-flush">
        <li class="list-group-item">
          Price:
          <b>
            ₹<%= listing.price ? Number(listing.price).toLocaleString("en-IN") : "Not Defined" %>
          </b>
        </li>
        <li class="list-group-item">Location: <b>
            <%= listing.location %>
          </b></li>
        <li class="list-group-item">Country: <b>
            <%= listing.country %>
          </b></li>
      </ul>
    </div>

    <!-- EDIT / DELETE BUTTONS -->
    <div class="row">
      <% if (currentUser && listing.owner._id.equals(currentUser._id)) { %>

        <div class="col-6">
          <a href="/listings/<%= listing._id %>/edit">
            <button type="button" class="btn btn-secondary w-100">Edit</button>
          </a>
        </div>

        <div class="col-6">
          <form action="/listings/<%= listing._id %>" method="POST"
            onsubmit="return confirm('Are you sure you want to delete this listing?');">
            <input type="hidden" name="_method" value="DELETE" />
            <button type="submit" class="btn btn-danger w-100">Delete</button>
          </form>
        </div>

        <% } %>
    </div>

    <div class="text-success">
      <hr class="mt-5" />
    </div>

    <!-- REVIEW FORM -->
    <% if (currentUser) { %>
      <h3 class="mt-3">Leave a Review</h3>

      <div class="row">
        <div class="col-12 col-lg-6">
          <div class="p-3">
            <form action="/listings/<%= listing._id %>/reviews" method="POST" novalidate class="needs-validation">
              <div class="mb-3">
                <label class="form-label">Write Comment</label>
                <div class="form-floating">
                  <textarea class="form-control" placeholder="Leave a comment" id="floatingTextarea2"
                    style="height: 100px" name="review[comment]" required></textarea>
                  <label for="floatingTextarea2">Comment</label>
                  <div class="invalid-feedback">Please enter a comment.</div>
                </div>
              </div>

              <label class="form-label">Rate out of 5</label>

              <fieldset class="starability-slot">
                <legend>Rate this listing</legend>

                <input type="radio" id="rate1" name="review[rating]" value="1" required />
                <label for="rate1">1 star</label>

                <input type="radio" id="rate2" name="review[rating]" value="2" />
                <label for="rate2">2 stars</label>

                <input type="radio" id="rate3" name="review[rating]" value="3" />
                <label for="rate3">3 stars</label>

                <input type="radio" id="rate4" name="review[rating]" value="4" />
                <label for="rate4">4 stars</label>

                <input type="radio" id="rate5" name="review[rating]" value="5" />
                <label for="rate5">5 stars</label>
              </fieldset>

              <button type="submit" class="btn btn-success mt-3">Submit</button>
            </form>
          </div>
        </div>
      </div>
      <% } %>

        <div class="text-success">
          <hr class="mt-5" />
        </div>

        <!-- REVIEW BOXES -->
        <h4 class="mt-5 d-flex align-items-center">
          All Reviews
          <span class="badge bg-primary ms-2">
            <%= listing.reviews ? listing.reviews.length : 0 %>
          </span>
        </h4>

        <div class="row gy-4 mt-3">
          <% if (listing.reviews && listing.reviews.length) { %>
            <% listing.reviews.forEach(function (review) { %>
              <div class="col-12 col-md-6 col-lg-4">
                <div class="card h-100 shadow-sm rounded-3">
                  <div class="card-body d-flex flex-column p-3 p-md-4">
                    <div class="d-flex align-items-start mb-2">
                      <div
                        class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center me-3"
                        style="width: 48px; height: 48px; font-weight: 600">
                        <%= review.author?.username ? review.author.username.charAt(0).toUpperCase() : 'U' %>
                      </div>

                      <div>
                        <h6 class="mb-0">
                          <%= review.author?.username || 'Unknown' %>
                        </h6>
                        <% if (review.createdAt) { %>
                          <small class="text-muted">
                            <%= new Date(review.createdAt).toLocaleDateString('en-IN', { year: 'numeric' ,
                              month: 'short' , day: 'numeric' }) %>
                          </small>
                          <% } %>
                      </div>
                    </div>

                    <h5 class="text-muted flex-grow-1 mb-3">
                      <%= review.comment %>
                    </h5>

                    <div class="d-flex justify-content-between align-items-center">
                      <div>
                        <p class="starability-result" data-rating="<%= review.rating %>">
                          Rated: <%= review.rating %> stars
                        </p>
                      </div>

                      <form action="/listings/<%= listing._id %>/reviews/<%= review._id %>" method="POST"
                        onsubmit="return confirm('Are you sure you want to delete this review?');">
                        <input type="hidden" name="_method" value="DELETE" />
                        <button type="submit" class="btn btn-sm btn-outline-danger">
                          Delete
                        </button>
                      </form>
                    </div>
                  </div>
                </div>
              </div>
              <% }) %>
                <% } else { %>

                  <div class="col-12">
                    <div class="alert alert-secondary mb-0 p-3">
                      No reviews yet — be the first to leave one!
                    </div>
                  </div>

                  <% } %>
        </div>
        <h3>Where you'll be</h3>
        <div id="map"></div>
  </div>

  <script src="https://cdn.maptiler.com/maptiler-sdk-js/v3.8.0/maptiler-sdk.umd.min.js"></script>
  <script src="/js/map.js"></script>